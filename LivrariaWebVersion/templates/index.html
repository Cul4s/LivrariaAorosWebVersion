<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Livraria - Web</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex align-items-center mb-3">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" width="56" height="56" class="me-3">
    <div>
      <h1 class="h4 mb-0">Sistema da Livraria (Web)</h1>
      <small class="text-muted">CRUD, CSV, backups e relatórios</small>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form id="form-add" class="row g-2">
        <div class="col-md-4"><input id="titulo" class="form-control" placeholder="Título" required></div>
        <div class="col-md-3"><input id="autor" class="form-control" placeholder="Autor" required></div>
        <div class="col-md-2"><input id="ano" class="form-control" placeholder="Ano"></div>
        <div class="col-md-2"><input id="preco" class="form-control" placeholder="Preço"></div>
        <div class="col-md-1 d-grid"><button class="btn btn-primary" type="submit">Adicionar</button></div>
      </form>
    </div>
  </div>

  <div class="d-flex gap-2 mb-3">
    <button id="btn-export" class="btn btn-outline-success">Exportar CSV</button>
    <label class="btn btn-outline-secondary mb-0">
      Importar CSV <input id="file-import" type="file" accept=".csv" hidden>
    </label>
    <button id="btn-backup" class="btn btn-outline-warning">Backup</button>
    <button id="btn-report-html" class="btn btn-outline-info">Relatório HTML</button>
    <button id="btn-report-pdf" class="btn btn-outline-dark">Relatório PDF</button>
    <input id="search" class="form-control ms-auto" placeholder="Buscar autor...">
  </div>

  <div id="msg"></div>

  <div class="card">
    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table table-sm table-hover" id="tbl-books">
          <thead class="table-light">
            <tr><th>ID</th><th>Título</th><th>Autor</th><th>Ano</th><th>Preço</th><th>Ações</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const api = {
  list: "/api/books",
  add: "/api/books",
  updatePrice: (id)=>`/api/books/${id}/price`,
  delete: (id)=>`/api/books/${id}`,
  search: (q)=>`/api/search?q=${encodeURIComponent(q)}`,
  export: "/api/export",
  import: "/api/import",
  backup: "/api/backup",
  reportHtml: "/api/report/html",
  reportPdf: "/api/report/pdf"
};

function showMsg(text, type="info"){
  const div = document.getElementById("msg");
  div.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
  setTimeout(()=> div.innerHTML = "", 4000);
}

async function fetchBooks(){
  const r = await fetch(api.list);
  const data = await r.json();
  renderTable(data);
}

function renderTable(books){
  const tbody = document.querySelector("#tbl-books tbody"); tbody.innerHTML = "";
  for(const b of books){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${escapeHtml(b.titulo)}</td>
      <td>${escapeHtml(b.autor)}</td>
      <td>${b.ano_publicacao || ""}</td>
      <td>${b.preco != null ? ("R$ " + Number(b.preco).toFixed(2)) : ""}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="promptPrice(${b.id})">Editar Preço</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteBook(${b.id})">Remover</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

document.getElementById("form-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const titulo = document.getElementById("titulo").value.trim();
  const autor = document.getElementById("autor").value.trim();
  const ano = document.getElementById("ano").value.trim();
  const preco = document.getElementById("preco").value.trim();
  const res = await fetch(api.add, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({titulo, autor, ano_publicacao: ano || null, preco: preco || null}) });
  if(res.ok){ showMsg("Livro adicionado","success"); document.getElementById("form-add").reset(); fetchBooks(); }
  else { const j = await res.json(); showMsg(j.error || "Erro","danger"); }
});

async function promptPrice(id){
  const novo = prompt("Novo preço (ex: 45.90):");
  if(novo === null) return;
  const res = await fetch(api.updatePrice(id), { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({preco: novo})});
  if(res.ok){ showMsg("Preço atualizado","success"); fetchBooks(); } else { const j=await res.json(); showMsg(j.error||"Erro","danger"); }
}

async function deleteBook(id){
  if(!confirm("Confirmar remoção?")) return;
  const res = await fetch(api.delete(id), { method:"DELETE" });
  if(res.ok){ showMsg("Livro removido","success"); fetchBooks(); } else { const j=await res.json(); showMsg(j.error||"Erro","danger"); }
}

document.getElementById("btn-export").addEventListener("click", ()=> window.location = api.export );

document.getElementById("file-import").addEventListener("change", async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const form = new FormData(); form.append("file", f);
  const res = await fetch(api.import, { method:"POST", body: form });
  const j = await res.json();
  if(res.ok) { showMsg(`${j.inserted} registros importados`,"success"); fetchBooks(); } else { showMsg(j.error||"Erro","danger"); }
});

document.getElementById("btn-backup").addEventListener("click", async ()=>{
  const r = await fetch(api.backup); const j = await r.json();
  if(r.ok) showMsg("Backup criado: " + j.backup, "success"); else showMsg("Erro","danger");
});

document.getElementById("btn-report-html").addEventListener("click", ()=> window.location = api.reportHtml );
document.getElementById("btn-report-pdf").addEventListener("click", async ()=>{
  const r = await fetch(api.reportPdf);
  const j = await r.json().catch(()=>null);
  if(r.ok){ window.location = api.reportPdf; } else { showMsg(j?.error || "Erro ao gerar PDF", "danger"); }
});

document.getElementById("search").addEventListener("input", async (e)=>{
  const q = e.target.value.trim();
  if(q === "") { fetchBooks(); return; }
  const r = await fetch(api.search(q)); const data = await r.json(); renderTable(data);
});

fetchBooks();
</script>
</body>
</html>
